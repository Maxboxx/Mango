class Mango{static none=0;static pretty=1;static commas=2;static quotes=4;static useNull=8;static json=14;static parse(e,t={}){let s=new Mango.#a(e);for(let i in t)s.scope.vars[i]=new Mango.#b(t[i]);let a=s.parseTaggedValue();if(s.parseWhitespace(),!s.isDone)throw"Invalid mango";return a.evaluate(s.scope)}static toString(e,t=Mango.none){let s=new Mango.#c(t);return s.writeValue(e),s.toString()}static #b=class{constructor(e){this.value=e}evaluate(e){return this.value}};static #d=class{constructor(e){this.name=e,this.isVar=!0}evaluate(e){return e.vars[this.name]?.evaluate(e)??null}value(e){return e.vars[this.name]??new Mango.#b(null)}};static #e=class{constructor(e){this.value=e,this.isUnpack=!0}evaluate(e,t){let s=this.value.evaluate(e)??null;if(Array.isArray(s)&&Array.isArray(t))for(let i of s)t.push(i);else if(null!==s&&null!==t&&"object"==typeof s&&"object"==typeof t)for(let a in s)t[a]=s[a];return t}};static #f=class{constructor(e,t,s){this.data=e,this.args=t,this.value=s}evaluate(e){let t=this.data.copy();for(let s=0;s<this.args.length;s++)s<e.length?t.vars[this.args[s]]=e[s]:t.vars[this.args[s]]=new Mango.#b(null);return this.value.evaluate(t)}};static #g=class{constructor(e,t){this.name=e,this.args=t}evaluate(e){let t=[];for(let s=0;s<this.args.length;s++)this.args[s].isVar?t.push(this.args[s].value(e)):t.push(this.args[s]);return e.templates[this.name]?.evaluate(t)??null}};static #h=class{constructor(e){this.segments=e??[]}evaluate(e){let t="";for(let s of this.segments){let i=s.evaluate(e);"string"==typeof i?t+=i:t+=Mango.toString(s.evaluate(e))}return t}};static #i=class{constructor(e,t){this.data=e,this.list=t??[]}evaluate(e){let t=[],s=this.data.combine(e);for(let i of this.list)i.isUnpack?i.evaluate(s,t):t.push(i.evaluate(s,t));return t}};static #j=class{constructor(e,t,s){this.data=e,this.obj=t??{},this.unpack=s??[]}evaluate(e){let t={},s=this.data.combine(e);for(let i of this.unpack)i.evaluate(s,t);for(let a in this.obj)t[a]=this.obj[a].evaluate(s);return t}};static #k=class{constructor(){this.vars={},this.templates={}}copy(){let e=new Mango.#k;for(let t in this.vars)e.vars[t]=this.vars[t];for(let s in this.templates)e.templates[s]=this.templates[s];return e}combine(e){let t=e.copy();for(let s in this.vars)t.vars[s]=this.vars[s];for(let i in this.templates)t.templates[i]=this.templates[i];return t}};static #a=class{constructor(e){this.str=e,this.index=0,this.scope=new Mango.#k,this.parseWhitespace()}get current(){return this.str.charAt(this.index)}get isDone(){return this.index>=this.str.length}peek(e){for(let t=0;t<e.length;t++)if(this.str.charAt(this.index+t)!==e.charAt(t))return!1;return!0}parseRaw(e){return!!this.peek(e)&&(this.index+=e.length,!0)}parseText(e){return!!this.parseRaw(e)&&(this.parseWhitespace(),!0)}parseToken(e){let t=this.parseRegex(e);if(t)return this.parseWhitespace(),t}parseRegex(e){e.lastIndex=this.index;let t=e.exec(this.str);if(t)return this.index+=t[0].length,t.length>1?t[1]:t[0]}parseWhitespace(){this.parseRegex(/[\s\r\n]+/y);let e=this.parseRegex(/\-\-(\/*)/y);if(void 0==e)return;let t=e.length;if(0==t)for(;"\r"!=this.current&&"\n"!=this.current&&!this.isDone;)this.index++;else for(;;){for(;"/"!=this.current;)if(this.index++,this.isDone)throw"Invalid comment";let s=0;for(;"/"==this.current;)s++,this.index++;if(s>=t&&this.parseRaw("--"))break;this.index++}this.parseRegex(/[\s\r\n]+/y)}parseName(){let e=this.index,t=this.parseToken(/[a-zA-Z0-9_]+\b/y);if(!t||"true"==t||"false"==t||"null"==t||"nil"==t||/^[0-9]+$/.test(t)){this.index=e;return}return t}parseTaggedValue(){let e=[],t=this.index;for(;!this.isDone;){let s=this.parseKey();if(void 0==s)break;e.push(s)}return e.length>0&&!this.parseText(":")&&(this.index=t),this.parseValue()}parseValue(){switch(this.current){case"n":if(this.parseToken(/(nil|null)\b/y))return new Mango.#b(null);case"t":case"f":{let e=this.parseToken(/(true|false)\b/y);if(e)return new Mango.#b("true"==e);break}case'"':return this.parseString();case"[":return this.parseList();case"{":return this.parseObject();case"$":{let t=this.parseVariable();return new Mango.#d(t)}case"#":return this.parseTemplateValue()}let s=this.parseToken(/\d*\.?\d+\b/y);if(s)return new Mango.#b(parseFloat(s));throw"Invalid mango value"}parseRawString(){return this.parseString(!0).value}parseString(e=!1){if(!this.parseRaw('"'))throw"Invalid string";this.index;let t="",s=[];for(;!this.isDone;){switch(this.current){case'"':if(this.index++,this.parseWhitespace(),!e&&s.length>0)return s.push(new Mango.#b(t)),new Mango.#h(s);return new Mango.#b(t);case"\r":case"\n":throw"Invalid string";case"\\":switch(this.str.charAt(this.index+1)){case"t":t+="	";break;case"r":t+="\r";break;case"n":t+="\n";break;case"{":if(e)break;if(this.index+=2,this.parseWhitespace(),s.push(new Mango.#b(t)),t="",s.push(this.parseTaggedValue()),!this.parseRaw("}"))throw"Invalid string";this.index-=2;break;default:t+=this.str.charAt(this.index+1)}this.index+=2;continue}t+=this.current,this.index++}throw"Invalid string"}parseList(){if(!this.parseText("["))throw"Invalid list";let e=[],t=this.scope.copy();for(;this.parseVarAssign()||this.parseTemplateAssign(););for(;!this.isDone;){let s=this.parseUnpack();if(void 0!==s?e.push(s):e.push(this.parseTaggedValue()),this.parseText("]")){let i=this.scope.copy();return this.scope=t,new Mango.#i(i,e)}this.parseText(",")}throw"Invalid list"}parseObject(){if(!this.parseText("{"))throw"Invalid object";let e={},t=[],s=this.scope.copy();for(;this.parseVarAssign()||this.parseTemplateAssign(););if(this.parseText("}")){let i=this.scope.copy();return this.scope=s,new Mango.#j(i,e,t)}for(;!this.isDone;){let a=this.parseUnpack();if(void 0!==a)t.push(a);else{let r=this.parseKey();if(void 0==r)throw"Invalid object";let n=[];for(;!this.isDone;){let h=this.parseKey();if(void 0==h)break;n.push(h)}if(!this.parseText(":"))throw"Invalid object";let l=this.parseValue();e[r]=l}if(this.parseText("}")){let p=this.scope.copy();return this.scope=s,new Mango.#j(p,e,t)}this.parseText(",")}throw"Invalid object"}parseKey(){return'"'==this.current?this.parseRawString():this.parseName()}parseUnpack(){let e=this.parseVarUnpack();if(e||(e=this.parseTemplateUnpack()))return e}parseVariable(){return this.parseToken(/\$([a-zA-Z0-9_]+)\b/y)}parseVarUnpack(){let e=this.parseToken(/\$\$([a-zA-Z0-9_]+)\b/y);if(void 0!=e)return new Mango.#e(new Mango.#d(e))}parseVarAssign(){let e=this.index;if(this.peek("$$"))return;let t=this.parseVariable();if(!this.parseText("=")){this.index=e;return}let s=this.parseValue();return this.scope.vars[t]=s,t}parseTemplateName(){return this.parseToken(/\#([a-zA-Z0-9_]+)\b/y)}parseTemplateValue(){let e=this.parseTemplateName();if(!e)throw"Invalid template";let t=[];if(!this.parseText("["))throw"Invalid template";if(this.parseText("]"))return new Mango.#g(e,t);for(;!this.isDone;){let s=this.parseValue();if(s&&t.push(s),this.parseText("]"))return new Mango.#g(e,t);this.parseText(",")}throw"Invalid template"}parseTemplateUnpack(){if(!this.peek("##"))return;this.index++;let e=this.parseTemplateValue();return new Mango.#e(e)}parseTemplateAssign(){let e=this.index;if(this.peek("##"))return;let t=this.parseTemplateName(),s=[],i=this.scope.copy();if(!this.parseText("["))return;if(!this.parseText("]"))for(;!this.isDone;){let a=this.parseVariable();if(void 0==a){this.index=e;return}if(s.push(a),this.parseText("]"))break;this.parseText(",")}if(!this.parseText("=")){this.index=e;return}let r=this.parseValue();return this.scope=i,this.scope.templates[t]=new Mango.#f(this.scope.copy(),s,r),t}};static #c=class{constructor(e){this.flags=e,this.segments=[]}toString(){return this.segments.join("")}writeValue(e,t=""){null==e?this.segments.push(this.flags&Mango.useNull?"null":"nil"):!0===e?this.segments.push("true"):!1===e?this.segments.push("false"):Array.isArray(e)?this.writeList(e,t):"object"==typeof e?this.writeObject(e,t):this.segments.push(JSON.stringify(e))}writeObject(e,t){let s=this.flags&Mango.pretty,i=t+"	";s?this.segments.push("{\n"+i):this.segments.push("{");let a=Object.keys(e);for(let r=0;r<a.length;r++)r>0&&(this.flags&Mango.commas?this.segments.push(s?",\n"+i:","):this.segments.push(s?"\n"+i:" ")),this.flags&Mango.quotes||!(/^[a-zA-Z0-9_]+$/.test(a[r])&&/[a-zA-Z_]/.test(a[r]))?this.segments.push(JSON.stringify(a[r])):this.segments.push(a[r]),this.segments.push(s?": ":":"),this.writeValue(e[a[r]],i);s?this.segments.push("\n"+t+"}"):this.segments.push("}")}writeList(e,t){let s=t+"	",i=this.flags&Mango.pretty;i?this.segments.push("[\n"+s):this.segments.push("[");for(let a=0;a<e.length;a++)a>0&&(this.flags&Mango.commas?this.segments.push(i?",\n"+s:","):this.segments.push(i?"\n"+s:" ")),this.writeValue(e[a],s);i?this.segments.push("\n"+t+"]"):this.segments.push("]")}}}